// CricScore Prisma Schema - Frozen State (Step 2)

generator client {
  provider = "prisma-client-js"
  output   = "../backend/node_modules/.prisma/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// 1. Authentication & User Profile
// -----------------------------------------------------------------------------

model User {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  firebaseUid        String    @unique
  email              String    @unique
  phoneNumber        String?   @unique
  username           String?   @unique // Auto-generated or custom
  autoUsername       String?   @unique // System generated fallback
  
  // Profile
  fullName           String
  profilePictureUrl  String?
  description        String?
  dateOfBirth        DateTime?
  city               String?
  state              String?
  country            String?   @default("India")
  jerseyNumber       Int?
  onboardingComplete Boolean   @default(false)
  
  // Cricket Stats
  role               Role?
  battingHand        BattingHand?
  battingPosition    BattingPosition?
  bowlingStyle       BowlingStyle?    // High level (Spin/Pace)
  bowlingSubType     BowlingSubType?  // Granular
  
  // Timestamps
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastSeenAt         DateTime?

  // Relations
  teams              TeamMember[]
  ownedTeams         Team[]              @relation("TeamOwner")
  locations          UserLocation[]
  apiKeys            ApiKey[]
  achievements       Achievement[]
  notifications      Notification[]
  
  // Dynamic Relations (Reverse lookups for specific roles in matches)
  manOfTheMatchAwards MatchSummary[]     @relation("ManOfTheMatch")
  tournamentCreated   Tournament[]       @relation("TournamentCreator")
  
  // Messaging
  sentMessages        Message[]          @relation("Sender")
  conversationMembers ConversationMember[]
  starredMessages     StarredMessage[]
  reactions           MessageReaction[]
  chatPollVotes       ChatPollVote[]


}

model UserLocation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  label       String   // "Home", "Office"
  latitude    Float
  longitude   Float
  isDefault   Boolean  @default(false)
  alertRadius Int      @default(10) // km
  
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

// -----------------------------------------------------------------------------
// 2. Team Management
// -----------------------------------------------------------------------------

model Team {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  shortName         String?   // Abbreviation (CSK)
  logoUrl           String?
  bannerUrl         String?
  city              String?
  description       String?
  
  // Access Control
  ownerId           String    @db.ObjectId
  inviteCode        String    @unique // For joining
  isPublic          Boolean   @default(true)
  
  // Reliability
  matchesConfirmed  Int       @default(0)
  matchesCancelled  Int       @default(0)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  owner             User            @relation("TeamOwner", fields: [ownerId], references: [id])
  members           TeamMember[]
  grounds           Ground[]
  matchSeekers      MatchSeeker[]
  inviteTemplates   InviteTemplate[]
  seasons           TeamSeason[]
  
  // Tournament Relations
  tournamentTeams   TournamentTeam[]

  // Matches (as Home or Away)
  homeMatches       MatchSummary[]  @relation("HomeTeam")
  awayMatches       MatchSummary[]  @relation("AwayTeam")

  @@index([ownerId])
}

model TeamMember {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  teamId    String          @db.ObjectId
  userId    String          @db.ObjectId
  role      TeamMemberRole  @default(PLAYER)
  joinedAt  DateTime        @default(now())
  
  team      Team            @relation(fields: [teamId], references: [id])
  user      User            @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamSeason {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  teamId    String   @db.ObjectId
  name      String   // "2026 Season"
  startDate DateTime
  endDate   DateTime?
  isActive  Boolean  @default(true)
  
  team      Team     @relation(fields: [teamId], references: [id])
}

// -----------------------------------------------------------------------------
// 3. Guest Players
// -----------------------------------------------------------------------------

model GuestPlayer {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  teamId      String?  @db.ObjectId // Optional if ad-hoc
  name        String
  phoneNumber String?
  profileUrl  String?  @unique // slug
  addedDuring GuestAddContext @default(TEAM_MANAGEMENT)
  
  battingStyle BattingHand?
  bowlingStyle BowlingStyle?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phoneNumber])
  @@index([teamId])
}

// -----------------------------------------------------------------------------
// 4. Ground & Location
// -----------------------------------------------------------------------------

model Ground {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  teamId    String?   @db.ObjectId // Ground can belong to a team
  name      String
  address   String?
  latitude  Float
  longitude Float
  pitchType PitchType?
  photos    String[]
  
  team      Team?     @relation(fields: [teamId], references: [id])

  @@index([latitude, longitude])
}

model MatchSeeker {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  teamId        String    @db.ObjectId
  preferredDate DateTime?
  preferredTime TimeSlot?
  overs         Int?
  ballType      BallType?
  message       String?
  latitude      Float
  longitude     Float
  radius        Int       @default(15)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  
  team          Team      @relation(fields: [teamId], references: [id])

  @@index([latitude, longitude])
  @@index([isActive, expiresAt])
}

model InviteTemplate {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  teamId      String    @db.ObjectId
  name        String
  groundId    String?   @db.ObjectId
  overs       Int
  time        String
  ballType    BallType?
  description String?
  
  team        Team      @relation(fields: [teamId], references: [id])
}

// -----------------------------------------------------------------------------
// 5. Match Summary & History
// -----------------------------------------------------------------------------

model MatchSummary {
  id                String      @id @default(auto()) @map("_id") @db.ObjectId
  matchType         MatchType   // TEAM_MATCH, LOCAL_MATCH
  status            MatchStatus @default(SCHEDULED)
  
  // Team Refs
  homeTeamName      String
  awayTeamName      String
  homeTeamId        String?     @db.ObjectId
  awayTeamId        String?     @db.ObjectId
  
  // Result
  result            String?
  winningTeamName   String?
  winMargin         String?
  manOfTheMatchId   String?     @db.ObjectId
  
  // Meta
  matchDate         DateTime
  venue             String?
  overs             Int
  ballType          BallType?
  powerplayEnabled  Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  homeTeam          Team?       @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam          Team?       @relation("AwayTeam", fields: [awayTeamId], references: [id])
  manOfTheMatch     User?       @relation("ManOfTheMatch", fields: [manOfTheMatchId], references: [id])
  innings           Innings[]
  highlights        MatchHighlight[]
  operations        MatchOp[]

  // Tournament
  tournamentFixtureId String?   @db.ObjectId

  @@index([matchDate])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([status])
}

model Innings {
  id                  String             @id @default(auto()) @map("_id") @db.ObjectId
  matchSummaryId      String             @db.ObjectId
  inningsNumber       Int                // 1 or 2
  battingTeamName     String
  battingTeamId       String?            @db.ObjectId
  bowlingTeamName     String
  bowlingTeamId       String?            @db.ObjectId
  
  totalRuns           Int                @default(0)
  totalWickets        Int                @default(0)
  totalBalls          Int                @default(0)
  overs               Float              @default(0.0) // 10.2
  
  extras              Json               // {wides, noBalls, byes, legByes, penalty}
  fallOfWickets       Json               // [{wicket, score, over, batsman}]
  
  matchSummary        MatchSummary       @relation(fields: [matchSummaryId], references: [id])
  
  // Performance Relations
  battingPerformances BattingPerformance[]
  bowlingPerformances BowlingPerformance[]
  partnerships        Partnership[]
  ballByBall          BallRecord[]

  @@index([matchSummaryId])
}

model BattingPerformance {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  inningsId       String   @db.ObjectId
  userId          String?  @db.ObjectId
  guestPlayerId   String?  @db.ObjectId
  playerName      String
  battingPosition Int?
  
  runs            Int      @default(0)
  balls           Int      @default(0)
  fours           Int      @default(0)
  sixes           Int      @default(0)
  strikeRate      Float    @default(0.0)
  
  isOut           Boolean  @default(false)
  dismissalType   String?
  dismissedBy     String?
  fielder         String?
  
  innings         Innings  @relation(fields: [inningsId], references: [id])

  @@index([userId])
  @@index([inningsId])
}

model BowlingPerformance {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  inningsId       String   @db.ObjectId
  userId          String?  @db.ObjectId
  guestPlayerId   String?  @db.ObjectId
  playerName      String
  
  overs           Float    @default(0.0)
  maidens         Int      @default(0)
  runs            Int      @default(0)
  wickets         Int      @default(0)
  economy         Float    @default(0.0)
  dotBalls        Int      @default(0)
  wides           Int      @default(0)
  noBalls         Int      @default(0)
  
  innings         Innings  @relation(fields: [inningsId], references: [id])

  @@index([userId])
  @@index([inningsId])
}

model Partnership {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  inningsId       String   @db.ObjectId
  wicketNumber    Int
  batsman1Name    String
  batsman2Name    String
  runs            Int      @default(0)
  balls           Int      @default(0)
  
  innings         Innings  @relation(fields: [inningsId], references: [id])
}

model BallRecord {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  inningsId       String   @db.ObjectId
  overNumber      Int
  ballNumber      Int
  
  batsmanName     String
  bowlerName      String
  
  runs            Int      @default(0)
  extraType       String?
  extraRuns       Int      @default(0)
  
  isWicket        Boolean  @default(false)
  wicketType      String?
  isBoundary      Boolean  @default(false)
  isSix           Boolean  @default(false)
  
  commentary      String?
  
  innings         Innings  @relation(fields: [inningsId], references: [id])

  @@index([inningsId])
}

model MatchHighlight {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  matchSummaryId  String   @db.ObjectId
  type            String
  overNumber      Float
  description     String
  playerName      String?
  score           String?
  
  matchSummary    MatchSummary @relation(fields: [matchSummaryId], references: [id])
}

model MatchOp {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  matchId         String   @db.ObjectId
  clientOpId      String
  opIndex         Int      // Sequence number
  payload         Json
  appliedAt       DateTime @default(now())
  appliedBy       String   @db.ObjectId // UserId

  match           MatchSummary @relation(fields: [matchId], references: [id])

  @@unique([matchId, opIndex])
  @@unique([matchId, clientOpId])
}

// -----------------------------------------------------------------------------
// 6. Messaging & Social
// -----------------------------------------------------------------------------

model Conversation {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  type               ConversationType // DIRECT, GROUP, TEAM, MATCH
  entityId           String?   @db.ObjectId // teamId or matchId
  name               String?
  isAnnouncementOnly Boolean   @default(false)
  isArchived         Boolean   @default(false)
  pinnedMessageIds   String[]
  
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  members            ConversationMember[]
  messages           Message[]
  polls              ChatPoll[]
}

model ConversationMember {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String    @db.ObjectId
  userId         String    @db.ObjectId
  
  role           MemberRole @default(MEMBER)
  joinedAt       DateTime   @default(now())
  
  mutedUntil     DateTime?
  wallpaper      String?
  labels         String[]
  lastReadMessageId String?
  
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  conversationId  String      @db.ObjectId
  senderId        String      @db.ObjectId
  type            MessageType @default(TEXT)
  content         String?
  mediaUrl        String?
  
  // Features
  replyToId       String?     @db.ObjectId
  forwardedFrom   String?
  mentions        String[] // User IDs
  linkPreview     Json?
  scheduledAt     DateTime?
  
  // Status
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deliveredAt     DateTime?
  readAt          DateTime?
  
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  sender          User         @relation("Sender", fields: [senderId], references: [id])
  
  starredBy       StarredMessage[]
  reactions       MessageReaction[]

  @@index([conversationId, createdAt])
}

model MessageReaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  userId    String   @db.ObjectId
  emoji     String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@index([messageId])
}

model ChatPoll {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String    @db.ObjectId
  messageId      String    @db.ObjectId
  question       String
  options        Json      // [{id, text}] - Voters stored in ChatPollVote
  isAnonymous    Boolean   @default(false)
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  votes          ChatPollVote[]
}

model ChatPollVote {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  pollId      String   @db.ObjectId
  userId      String   @db.ObjectId
  optionId    String
  createdAt   DateTime @default(now())
  
  poll        ChatPoll @relation(fields: [pollId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
  
  @@unique([pollId, userId])
}

model StarredMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  messageId String   @db.ObjectId
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  message   Message  @relation(fields: [messageId], references: [id])
  
  @@unique([userId, messageId])
}

model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}

// -----------------------------------------------------------------------------
// 7. Tournament
// -----------------------------------------------------------------------------

model Tournament {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  format          TournamentFormat
  overs           Int
  ballType        BallType?
  maxTeams        Int
  
  startDate       DateTime
  endDate         DateTime?
  status          TournamentStatus @default(UPCOMING)
  
  createdById     String      @db.ObjectId
  venueId         String?     @db.ObjectId
  bannerImage     String?
  rules           Json?
  
  createdBy       User        @relation("TournamentCreator", fields: [createdById], references: [id])
  
  teams           TournamentTeam[]
  groups          TournamentGroup[]
  fixtures        TournamentFixture[]
  standings       TournamentStanding[]
}

model TournamentTeam {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  tournamentId  String      @db.ObjectId
  teamId        String      @db.ObjectId
  groupId       String?     @db.ObjectId
  seedNumber    Int?
  
  tournament    Tournament  @relation(fields: [tournamentId], references: [id])
  team          Team        @relation(fields: [teamId], references: [id])

  @@unique([tournamentId, teamId])
}

model TournamentGroup {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  tournamentId  String      @db.ObjectId
  name          String
  
  tournament    Tournament  @relation(fields: [tournamentId], references: [id])
}

model TournamentFixture {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  tournamentId    String      @db.ObjectId
  round           String      // "Group A - Match 1", "Semi-Final"
  matchNumber     Int
  
  homeTeamId      String?     @db.ObjectId
  awayTeamId      String?     @db.ObjectId
  matchSummaryId  String?     @db.ObjectId // Linked match
  
  scheduledDate   DateTime?
  groundId        String?     @db.ObjectId
  status          FixtureStatus @default(UPCOMING)
  winnerId        String?     @db.ObjectId
  
  tournament      Tournament  @relation(fields: [tournamentId], references: [id])

  @@unique([tournamentId, round, matchNumber])
  @@index([tournamentId])
}

model TournamentStanding {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  tournamentId  String      @db.ObjectId
  groupId       String?     @db.ObjectId
  teamId        String      @db.ObjectId
  
  played        Int         @default(0)
  won           Int         @default(0)
  lost          Int         @default(0)
  tied          Int         @default(0)
  noResult      Int         @default(0)
  points        Int         @default(0)
  netRunRate    Float       @default(0.0)
  
  tournament    Tournament  @relation(fields: [tournamentId], references: [id])

  @@unique([tournamentId, teamId])
}

// -----------------------------------------------------------------------------
// 8. Public API & Extras
// -----------------------------------------------------------------------------

model ApiKey {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  key         String    @unique
  name        String
  permissions String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?
  
  user        User      @relation(fields: [userId], references: [id])
}

model Achievement {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  type        AchievementType
  unlockedAt  DateTime @default(now())
  matchId     String?  @db.ObjectId
  
  user        User     @relation(fields: [userId], references: [id])
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum Role {
  BATSMAN
  BOWLER
  ALL_ROUNDER
  WICKET_KEEPER_BATSMAN
}

enum BattingHand {
  RIGHT_HANDED
  LEFT_HANDED
}

enum BattingPosition {
  OPENER
  TOP_ORDER
  MIDDLE_ORDER
  LOWER_ORDER
  FINISHER
}

enum BowlingStyle {
  RIGHT_ARM_FAST
  RIGHT_ARM_MEDIUM
  LEFT_ARM_FAST
  LEFT_ARM_MEDIUM
  RIGHT_ARM_SPIN
  LEFT_ARM_SPIN
}

enum BowlingSubType {
  RIGHT_ARM_FAST
  RIGHT_ARM_MEDIUM
  LEFT_ARM_FAST
  LEFT_ARM_MEDIUM
  RIGHT_ARM_OFF_SPIN
  RIGHT_ARM_LEG_SPIN
  LEFT_ARM_ORTHODOX
  LEFT_ARM_CHINAMAN
  SLOW_LEFT_ARM
}

enum TeamMemberRole {
  OWNER
  CAPTAIN
  VICE_CAPTAIN
  PLAYER
}

enum GuestAddContext {
  TEAM_MANAGEMENT
  MATCH_SETUP
  MID_MATCH
}

enum PitchType {
  TURF
  MAT
  CEMENT
  SYNTHETIC
}

enum TimeSlot {
  MORNING
  AFTERNOON
  EVENING
}

enum BallType {
  STITCH
  RED_TENNIS
  GREEN_TENNIS
  WHITE_TENNIS
  CORK
}

enum MatchType {
  TEAM_MATCH
  LOCAL_MATCH
}

enum MatchStatus {
  SCHEDULED
  LIVE
  COMPLETED
  ABANDONED
}

enum ConversationType {
  DIRECT
  GROUP
  TEAM
  MATCH
}

enum MemberRole {
  ADMIN
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  SYSTEM
  SCORECARD
  POLL
  CHALLENGE
  SQUAD
  STICKER
}

enum NotificationType {
  TEAM_INVITE
  MATCH_INVITE
  MATCH_REMINDER
  MESSAGE
  MENTION
  PROXIMITY_ALERT
  TOURNAMENT_UPDATE
  ACHIEVEMENT
  SYSTEM
}

enum TournamentFormat {
  LEAGUE
  KNOCKOUT
  GROUP_KNOCKOUT
}

enum TournamentStatus {
  UPCOMING
  REGISTRATION
  GROUP_STAGE
  KNOCKOUTS
  COMPLETED
  CANCELLED
}

enum FixtureStatus {
  UPCOMING
  LIVE
  COMPLETED
  CANCELLED
  NO_RESULT
}

enum AchievementType {
  FIRST_MATCH
  FIRST_FIFTY
  FIRST_CENTURY
  HAT_TRICK
  FIVE_WICKET_HAUL
  TEN_MATCHES
  FIFTY_MATCHES
  HUNDRED_MATCHES
  SIX_MACHINE
  GOLDEN_DUCK
  CAPTAIN
  TOURNAMENT_WINNER
}
